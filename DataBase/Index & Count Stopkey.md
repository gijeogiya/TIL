# COUNT STOPKEY와 인덱스
> 효율적인 데이터 검색의 핵심

사무실에서 키가 가장 큰 10명을 찾는 상황을 상상해보자. 인덱스가 없다면 모든 직원을 로비에 모아 키를 재고 정렬해야 할 것이다. 하지만 키 순서부(인덱스)가 있다면? 순서부에서 상위 10명만 확인하고 호출하면 끝이다. 이처럼 데이터베이스에서 COUNT STOPKEY와 인덱스의 관계도 이와 유사하다.

## COUNT STOPKEY란?

COUNT STOPKEY는 Oracle 데이터베이스에서 사용되는 쿼리 최적화 기법이다. 특정 조건을 만족하는 행의 수가 지정된 값에 도달하면 즉시 검색을 중단하는 기능이다.

## 인덱스와 COUNT STOPKEY의 시너지

### 1. 빠른 데이터 접근
- 인덱스가 없을 때: 전체 테이블 스캔이 필요하다.
- 인덱스가 있을 때: 필요한 데이터에 직접 접근할 수 있다.

### 2. 정렬 작업 최소화
- 인덱스가 없을 때: 실시간으로 전체 데이터를 정렬해야 한다.
- 인덱스가 있을 때: 이미 정렬된 구조를 활용할 수 있다.

### 3. 메모리 사용 최적화
- 인덱스가 없을 때: 대량의 데이터를 메모리에 로드해야 한다.
- 인덱스가 있을 때: 필요한 데이터만 메모리에 로드하면 된다.

## 효율적인 COUNT STOPKEY 사용을 위한 인덱스 전략

1. **복합 인덱스 활용**
   ```sql
   CREATE INDEX emp_gender_height_idx ON employees(gender, height DESC);
   ```
   이렇게 하면 성별과 키를 기준으로 빠르게 검색할 수 있다.

2. **인덱스 순서 최적화**
   - 가장 자주 사용되는 조건을 인덱스의 첫 번째 컬럼으로 지정하는 것이 좋다.

3. **쿼리 힌트 사용**
   ```sql
   SELECT /*+ INDEX_DESC(e emp_gender_height_idx) */ 
   e.employee_id, e.name, e.height
   FROM employees e
   WHERE e.gender = 'M'
   AND ROWNUM <= 10
   ORDER BY e.height DESC;
   ```
   이 힌트는 옵티마이저에게 특정 인덱스를 사용하도록 지시한다. 이 쿼리는 남자 직원 중 키가 가장 큰 10명을 효율적으로 추출한다.

## 인덱스 사용 여부에 따른 실행 계획 비교

### 인덱스를 사용하지 않은 경우
```
---------------------------------------
| Id | Operation         | A-Rows     |
---------------------------------------
|  0 | SELECT STATEMENT  |         10 |
|  1 |  COUNT STOPKEY    |         10 |
|  2 |   VIEW            |         10 |
|  3 |    SORT ORDER BY  |     100000 |
|  4 |     TABLE ACCESS  |     100000 |
---------------------------------------
```
이 경우, A-Rows에 모든 직원 수(100,000명)가 표시된다. 이는 전체 테이블을 스캔하고 모든 데이터를 정렬한 후에야 상위 10명을 선택할 수 있음을 의미한다.

### 인덱스를 사용한 경우
```
---------------------------------------
| Id | Operation         | A-Rows     |
---------------------------------------
|  0 | SELECT STATEMENT  |         10 |
|  1 |  COUNT STOPKEY    |         10 |
|  2 |   VIEW            |         10 |
|  3 |    INDEX DESC     |         10 |
---------------------------------------
```
인덱스를 사용하면 A-Rows에 10만 표시된다. 이는 필요한 10개의 행만 처리했음을 의미하며, 훨씬 효율적이다.

## 주의사항

1. **인덱스 과다 사용 주의**
   - 너무 많은 인덱스는 INSERT, UPDATE, DELETE 성능을 저하시킬 수 있다.

2. **통계 정보 최신화**
   ```sql
   EXEC DBMS_STATS.GATHER_TABLE_STATS('HR', 'EMPLOYEES');
   ```
   주기적인 통계 갱신으로 옵티마이저가 최적의 실행 계획을 수립할 수 있게 해야 한다.

3. **대용량 데이터 처리 시 주의**
   - 매우 큰 OFFSET 값은 성능 저하를 일으킬 수 있다.

## 결론

COUNT STOPKEY는 강력한 최적화 도구지만, 그 효과를 최대화하려면 적절한 인덱스 설계가 필수다. 마치 잘 정리된 키 순서부가 있어야 빠르게 키 큰 직원을 찾을 수 있는 것처럼, 데이터베이스에서도 잘 설계된 인덱스가 COUNT STOPKEY의 성능을 극대화할 수 있다. 실행 계획에서 볼 수 있듯이, 인덱스 사용 시 처리되는 행 수가 크게 줄어 성능이 대폭 향상된다. 따라서 쿼리 패턴을 분석하고, 그에 맞는 인덱스를 설계하는 것이 효율적인 데이터 검색의 핵심이다.