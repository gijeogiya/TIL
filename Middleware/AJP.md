# AJP (Apache JServ Protocol)

## 개요
AJP는 웹 서버(WEB)와 웹 애플리케이션 서버(WAS) 간의 고성능 통신을 위해 설계된 바이너리 프로토콜이다. 주로 Apache 웹 서버와 Tomcat, JBoss 등의 Java 기반 WAS 연동에 사용된다.

## 주요 특징

### 1. 이진 프로토콜 구조
- HTTP의 텍스트 기반 통신과 달리 바이너리 데이터를 사용한다
- 헤더 파싱 오버헤드를 60-80% 감소시킨다
- 8KB 단위로 데이터를 분할 전송한다

### 2. 아키텍처 구성
- 기본 통신 흐름은 클라이언트 → (HTTP) → 웹 서버 → (AJP) → WAS이다
- 기본 포트는 8009이다
- 사용 모듈은 mod_jk(Apache 1.x) 또는 mod_proxy_ajp(Apache 2.x)이다

### 3. 성능 최적화 기술
- Persistent Connection: 단일 TCP 연결로 다중 요청을 처리한다
- Connection Pooling: 사전에 생성된 연결을 재사용한다
- 패킷 최적화: HTTP 헤더를 0xA001~0xA00E 코드로 압축 표현한다

### 4. HTTP 요청 전가
AJP의 주요 장점 중 하나는 웹 서버가 HTTP 요청을 WAS에게 효율적으로 전가할 수 있다는 점이다. 이는 다음과 같은 이점을 제공한다:
- 웹 서버의 부하를 줄이고 WAS의 처리 능력을 최대화한다
- 복잡한 비즈니스 로직을 WAS에서 처리하게 함으로써 시스템 구조를 단순화한다
- 정적 콘텐츠와 동적 콘텐츠의 처리를 효과적으로 분리할 수 있다

## 보안 고려사항

### 주요 취약점 사례

| 취약점         | 영향                       | 대응 방안              |
|---------------|---------------------------|------------------------|
| CVE-2020-1938 | 파일 읽기/실행 권한 탈취    | AJP 포트 외부 노출 차단 |
| CVE-2020-1745 | Undertow 서버 공격         | 최신 패치 적용          |

- 클리어 텍스트 전송이 기본이며, SSL/TLS 지원이 제한적이다
- 신뢰할 수 있는 내부 네트워크에서만 사용이 권장된다

## HTTP vs AJP 비교

| 항목           | AJP                      | HTTP                   |
|----------------|--------------------------|------------------------|
| 프로토콜 타입   | Binary                   | Text                   |
| 연결 방식      | Persistent Connection    | Stateless              |
| 최대 패킷 크기  | 8KB(헤더), 64KB(본문)    | 제한 없음              |
| 보안           | 내부 전용 권장           | HTTPS 지원             |
| 사용 사례      | WEB-WAS 연동 최적화      | 범용 통신              |

## 구현 예시

Apache에서 Tomcat 연동 시 workers.properties 설정은 다음과 같다:

```properties
worker.list=worker1
worker.worker1.type=ajp13
worker.worker1.host=localhost
worker.worker1.port=8009
```

이후 `JkMount /* worker1` 지시어로 모든 요청을 WAS로 전달한다.

## 결론
AJP는 1997년 개발 이후 20년 이상 검증된 기술로, 특히 대규모 Java 기반 시스템에서 여전히 널리 사용된다. 그러나 최근에는 HTTP/2와 gRPC 같은 현대적 프로토콜이 점차 대체하고 있는 추세이다. AJP의 HTTP 요청 전가 기능은 웹 서버와 WAS 간의 효율적인 작업 분담을 가능하게 하여, 전체 시스템의 성능과 확장성을 향상시키는 데 큰 역할을 한다.